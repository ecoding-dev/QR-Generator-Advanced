<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>QR Visual Analyzer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7faf9;
      --card:#ffffff;
      --ink:#0f172a;
      --sub:#475569;
      --muted:#94a3b8;
      --accent:#0ea5e9;
      --accent-ink:#0b6da0;
      --ring:#bae6fd;
      --ok:#16a34a;
      --border:#e5e7eb;
      --chip:#eef2f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji';
      line-height:1.35;
    }
    header{
      padding:24px 20px 8px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:36px; height:36px; display:grid; place-items:center;
      border-radius:10px; background:var(--ink); color:#fff; font-weight:700;
      box-shadow:0 2px 0 rgba(15,23,42,.15);
    }
    .subtitle{color:var(--sub); font-size:14px}

    .container{
      max-width:1100px; margin:16px auto 40px; padding:0 20px;
      display:grid; gap:16px;
      grid-template-columns: 1.1fr .9fr; /* izquierda controles, derecha preview */
    }
    @media (max-width:980px){
      .container{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 0 rgba(15,23,42,.03);
    }
    h2{margin:.1rem 0 10px; font-size:18px}
    h3{margin:.6rem 0 10px; font-size:16px}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .row-3{display:grid; gap:12px; grid-template-columns:repeat(3,1fr)}
    .row-4{display:grid; gap:12px; grid-template-columns:repeat(4,1fr)}
    @media (max-width:720px){
      .row,.row-3,.row-4{grid-template-columns:1fr}
    }

    label{font-size:12px; font-weight:600; color:var(--sub); margin-bottom:6px}
    input[type="text"], select, input[type="number"]{
      width:100%; border:1px solid var(--border); background:#fff; color:var(--ink);
      padding:10px 12px; border-radius:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      outline:none; box-shadow:0 0 0 0px var(--ring);
    }
    input[type="text"]:focus, select:focus, input[type="number"]:focus{
      border-color:var(--accent); box-shadow:0 0 0 4px var(--ring);
    }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--ink); background:var(--ink); color:#fff;
      padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none;
    }
    .btn:hover{opacity:.92}
    .btn.secondary{
      background:#fff; color:var(--ink); border-color:var(--border);
    }
    .btn.secondary:hover{border-color:var(--ink)}
    .btn:disabled,.btn.disabled{opacity:.55; pointer-events:none}

    .block-title{
      display:flex; align-items:center; gap:8px; margin-bottom:10px;
      font-weight:700
    }
    .hint{color:var(--muted); font-size:12px}

    .stack{display:flex; flex-direction:column; gap:12px}

    .preview-wrap{
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#0b1224,#0f1b2f);
      border-radius:14px; padding:14px; border:1px solid var(--border);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .preview-inner{
      background:#111827; padding:14px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
    }
    .qr-img{
      display:block; width:300px; height:auto; border-radius:10px;
      border:1px solid rgba(255,255,255,.2); background:#0f172a;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 8px}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; background:var(--chip); color:var(--ink);
      font-size:12px; border:1px solid var(--border);
    }
    .metrics{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    .metric{
      background:var(--chip); border:1px solid var(--border); border-radius:10px;
      padding:10px; font-size:13px
    }
    .metric b{display:block; font-size:12px; color:var(--sub); font-weight:700}

    .downloads{display:flex; gap:10px; flex-wrap:wrap}
    .dl{padding:9px 12px; border-radius:10px; border:1px solid var(--border); background:#fff;
        display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--ink)}
    .dl:hover{border-color:var(--ink)}

    .legend-list{display:grid; gap:8px; grid-template-columns:1fr 1fr}
    @media (max-width:720px){.legend-list{grid-template-columns:1fr}}
    .sw{display:inline-block; width:16px; height:12px; border-radius:4px; margin-right:8px; border:1px solid var(--border)}
    .muted{color:var(--sub)}
    details{border:1px dashed var(--border); border-radius:12px; padding:10px 12px; background:#f9fbfc}
    summary{cursor:pointer; font-weight:700; color:var(--accent-ink)}
    .center{display:flex; align-items:center; justify-content:center}
    .err{color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; padding:10px 12px; border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo">QR</div>
      <div>
        <h1 style="margin:0;font-size:22px">QR Visual Analyzer</h1>
        <div class="subtitle">Modern QR code generator with advanced configuration</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Columna izquierda: formulario -->
    <section class="stack">
      <form method="post" class="card">
        <div class="block-title">⚡ Quick Generate</div>
        <div class="row">
          <div>
            <label>Text or URL</label>
            <input type="text" name="text" value="{{text|e}}" placeholder="Ingresa el payload EMVCo / string" />
          </div>
          <div>
            <label>Error Correction</label>
            <select name="ecc">
              {% for v in ['L','M','Q','H'] %}
                <option value="{{v}}" {% if ecc==v %}selected{% endif %}>
                  {{ 'M - 15% recovery (Yape)' if v=='M' else v }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Version</label>
            <select name="version">
              <option value="auto" {% if version=='auto' %}selected{% endif %}>Auto (minimum)</option>
              {% for v in range(1,41) %}
                <option value="{{v}}" {% if version|int==v %}selected{% endif %}>v{{v}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="center">
            <button class="btn" type="submit" style="width:100%; justify-content:center">
              Generate QR Code
            </button>
          </div>
        </div>

        <details {% if not qr %}open{% endif %} style="margin-top:10px">
          <summary>⚙️ Advanced Settings</summary>
          <div style="margin-top:12px" class="row-4">
            <div>
              <label>Mode</label>
              <select name="mode">
                {% for v in ['byte','alphanumeric','numeric','kanji'] %}
                  <option value="{{v}}" {% if mode==v %}selected{% endif %}>
                    {{ 'Byte (UTF-8)' if v=='byte' else v }}
                  </option>
                {% endfor %}
              </select>
              <div class="hint">Para clonar Yape: <b>byte</b></div>
            </div>

            <div>
              <label>Encoding</label>
              <input type="text" name="encoding" value="{{encoding|e}}" />
              <div class="hint">Ej: utf-8, iso-8859-1</div>
            </div>

            <div>
              <label>ECI</label>
              <select name="eci">
                <option value="true"  {% if eci %}selected{% endif %}>True (UTF-8)</option>
                <option value="false" {% if not eci %}selected{% endif %}>False</option>
              </select>
            </div>

            <div>
              <label>Mask Pattern</label>
              <select name="mask">
                <option value="auto" {% if mask=='auto' %}selected{% endif %}>auto</option>
                {% for m in range(8) %}
                  <option value="{{m}}" {% if mask|int==m %}selected{% endif %}>{{m}}</option>
                {% endfor %}
              </select>
              <div class="hint">Yape: 2</div>
            </div>

            <div>
              <label>Boost Error</label>
              <select name="boost_error">
                <option value="false" {% if not boost_error %}selected{% endif %}>False</option>
                <option value="true"  {% if boost_error %}selected{% endif %}>True</option>
              </select>
            </div>

            <div>
              <label>Micro QR</label>
              <select name="micro">
                <option value="false" {% if not micro %}selected{% endif %}>False</option>
                <option value="true"  {% if micro %}selected{% endif %}>True</option>
              </select>
            </div>

            <div>
              <label>Quiet Zone</label>
              <input type="number" name="border" min="0" max="20" step="1" value="{{border}}" />
              <div class="hint">Módulos (Yape: 4)</div>
            </div>
          </div>
        </details>
      </form>

      <section class="card">
        <h3>QR Code Structure</h3>
        <div class="legend-list">
          <div class="muted"><span class="sw" style="background:rgb(128,0,128)"></span> Finder patterns (3 corners)</div>
          <div class="muted"><span class="sw" style="background:rgb(230,230,230)"></span> Separator (visual)</div>
          <div class="muted"><span class="sw" style="background:rgb(255,165,0)"></span> Timing patterns (row 6, column 6)</div>
          <div class="muted"><span class="sw" style="background:rgb(0,128,128)"></span> Alignment patterns</div>
          <div class="muted"><span class="sw" style="background:rgb(255,0,0)"></span> Format bits</div>
          <div class="muted"><span class="sw" style="background:rgb(180,0,0)"></span> Version bits (v ≥ 7)</div>
          <div class="muted"><span class="sw" style="background:rgb(35,35,35)"></span> Data area (data + ECC)</div>
        </div>
      </section>
    </section>

    <!-- Columna derecha: preview y descargas -->
    <section class="stack">
      <div class="card">
        <h2>Generated QR Code</h2>
        <div class="muted">Your QR code will appear here after generation</div>

        {% if error %}
          <div class="err" style="margin-top:12px">{{error}}</div>
        {% endif %}

        {% if qr %}
          <div class="preview-wrap" style="margin-top:14px">
            <div class="preview-inner">
              <a href="data:image/png;base64,{{qr.img_b64}}" target="_blank" title="Abrir PNG en nueva pestaña">
                <img class="qr-img" src="data:image/png;base64,{{qr.img_b64}}" alt="QR v{{qr.version}}" />
              </a>
            </div>
          </div>

          <div class="chips">
            <span class="chip">v{{qr.version}}</span>
            <span class="chip">{{qr.size}}×{{qr.size}}</span>
            <span class="chip">Mask {{qr.mask}}</span>
            <span class="chip">ECC {{qr.ecc}}</span>
          </div>

          <div class="metrics">
            <div class="metric"><b>Dark Modules</b>{{qr.dark_modules}} / {{qr.modules}}</div>
            <div class="metric"><b>Functional Modules</b>{{qr.functional_modules}}</div>
            <div class="metric"><b>Data Modules</b>{{qr.data_modules}}</div>
            <div class="metric" style="background:#e0f7fa; border-color:#0ea5e9;">
              <b style="color:#0ea5e9;">Best Mask</b>
              <span style="color:#0ea5e9;">{{qr.best_mask}}</span>
              <span class="muted">(score: {{qr.best_score}})</span>
            </div>
          </div>

          <div style="margin-top:10px">
            <div class="downloads">
              {% set qs = ('?text=' ~ text|urlencode ~ '&ecc=' ~ ecc ~ '&version=' ~ version ~ '&mode=' ~ mode ~
                           '&encoding=' ~ encoding|urlencode ~ '&eci=' ~ ('true' if eci else 'false') ~
                           '&mask=' ~ mask ~ '&boost_error=' ~ ('true' if boost_error else 'false') ~
                           '&micro=' ~ ('true' if micro else 'false') ~ '&border=' ~ border) %}
              <a class="dl" href="{{ url_for('export_png_bw') ~ qs }}" title="Descargar PNG (B/N)">
                <!-- icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-4-4m4 4l4-4M4 21h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                PNG
              </a>
              <a class="dl" href="{{ url_for('export_svg_separate') ~ qs }}" title="Descargar SVG (módulos separados)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="6" height="6" stroke="currentColor" stroke-width="1.6"/><rect x="15" y="3" width="6" height="6" stroke="currentColor" stroke-width="1.6"/><rect x="3" y="15" width="6" height="6" stroke="currentColor" stroke-width="1.6"/></svg>
                SVG
              </a>
              <a class="dl" href="{{ url_for('export_jpg_bw') ~ qs }}" title="Descargar JPG (alta)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="1.6"/><circle cx="9" cy="10" r="2" stroke="currentColor" stroke-width="1.6"/><path d="M4 16l4-4 4 4 4-3 4 3" stroke="currentColor" stroke-width="1.6"/></svg>
                JPG
              </a>
              <a class="dl" href="{{ url_for('export_svg_colored') ~ qs }}" title="Descargar SVG (coloreado por zonas)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="3" width="6" height="6" fill="#800080" stroke="currentColor" stroke-width="0.6"/>
                  <rect x="15" y="3" width="6" height="6" fill="#00A0A0" stroke="currentColor" stroke-width="0.6"/>
                  <rect x="3" y="15" width="6" height="6" fill="#FFA500" stroke="currentColor" stroke-width="0.6"/>
                </svg>
                SVG (colored)
              </a>
            </div>
            <div class="hint" style="margin-top:6px">Los archivos usan exactamente los parámetros actuales (versión, ECC, máscara, quiet zone, etc.).</div>
          </div>
        {% endif %}
      </div>
    </section>
  </main>
</body>
</html>
